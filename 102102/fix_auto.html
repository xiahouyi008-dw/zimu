<!DOCTYPE html>
<html>
<head>
    <title>è‡ªåŠ¨ä¿®å¤æŒ‘æˆ˜ç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f0f0;
            text-align: center;
        }
        .fix-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .fix-button:hover { background: #45a049; }
        .status { 
            margin: 20px 0; 
            padding: 15px; 
            background: white; 
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .instructions {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .test-area {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ æŒ‘æˆ˜ç³»ç»Ÿè‡ªåŠ¨ä¿®å¤å·¥å…·</h1>
    
    <div class="instructions">
        <h3>ğŸ“‹ ä½¿ç”¨æ­¥éª¤ï¼š</h3>
        <ol>
            <li>ç‚¹å‡»ä¸‹æ–¹æ©™è‰²æŒ‰é’®ã€æ‰“å¼€æ¸¸æˆé¡µé¢ã€‘</li>
            <li>æ¸¸æˆé¡µé¢æ‰“å¼€åï¼Œç‚¹å‡»ç»¿è‰²æŒ‰é’®ã€åº”ç”¨è‡ªåŠ¨ä¿®å¤ã€‘</li>
            <li>ä¿®å¤å®Œæˆåï¼Œç‚¹å‡»é‡‘å¸æµ‹è¯•æŒ‘æˆ˜è¿›åº¦æ˜¯å¦æ›´æ–°</li>
        </ol>
    </div>

    <button class="fix-button" onclick="openGame()" style="background: #ff9800;">ğŸ® æ‰“å¼€æ¸¸æˆé¡µé¢</button>
    <button class="fix-button" onclick="applyAutoFix()">ğŸ”§ åº”ç”¨è‡ªåŠ¨ä¿®å¤</button>
    <button class="fix-button" onclick="testChallenge1()" style="background: #2196F3;">ğŸ¯ æµ‹è¯•æŒ‘æˆ˜1</button>
    
    <div id="status" class="status">ç­‰å¾…æ“ä½œ...</div>
    
    <div class="test-area">
        <h3>ğŸ§ª å¿«é€Ÿæµ‹è¯•åŒº</h3>
        <p>ä¿®å¤åï¼Œç‚¹å‡»ä¸‹é¢çš„æµ‹è¯•æŒ‰é’®æ¨¡æ‹Ÿæ¸¸æˆæ“ä½œï¼š</p>
        <button onclick="simulateCoinClick()">ğŸ’° æ¨¡æ‹Ÿç‚¹å‡»é‡‘å¸</button>
        <button onclick="simulateAccurateClick()">ğŸ¯ æ¨¡æ‹Ÿç²¾å‡†ç‚¹å‡»</button>
        <button onclick="checkChallengeStatus()">ğŸ“Š æŸ¥çœ‹æŒ‘æˆ˜çŠ¶æ€</button>
    </div>

    <script>
        let gameWindow = null;
        let fixApplied = false;

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.style.borderLeftColor = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#ff9800';
        }

        function openGame() {
            try {
                gameWindow = window.open('/æ‘¸é±¼é‡‘å¸.html', 'game', 'width=1200,height=800');
                updateStatus('âœ… æ¸¸æˆé¡µé¢å·²æ‰“å¼€ï¼ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ...', 'success');
                
                // ç­‰å¾…æ¸¸æˆåŠ è½½
                setTimeout(() => {
                    updateStatus('ğŸ® æ¸¸æˆåŠ è½½å®Œæˆï¼ç°åœ¨å¯ä»¥åº”ç”¨è‡ªåŠ¨ä¿®å¤äº†ã€‚');
                }, 3000);
                
            } catch (error) {
                updateStatus('âŒ æ— æ³•æ‰“å¼€æ¸¸æˆé¡µé¢ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ http://localhost:3000/æ‘¸é±¼é‡‘å¸.html', 'error');
            }
        }

        function applyAutoFix() {
            if (!gameWindow || gameWindow.closed) {
                updateStatus('âŒ è¯·å…ˆæ‰“å¼€æ¸¸æˆé¡µé¢ï¼', 'error');
                return;
            }

            try {
                const gameDoc = gameWindow.document;
                const gameWindowObj = gameWindow;

                // æ³¨å…¥ä¿®å¤è„šæœ¬
                const script = gameDoc.createElement('script');
                script.textContent = `
                    // ğŸš€ è‡ªåŠ¨ä¿®å¤æŒ‘æˆ˜ç³»ç»Ÿ
                    console.log('ğŸ”„ å¼€å§‹è‡ªåŠ¨ä¿®å¤æŒ‘æˆ˜ç³»ç»Ÿ...');
                    
                    // ç¡®ä¿dailyChallengeså­˜åœ¨
                    if (!window.dailyChallenges) {
                        console.log('âŒ dailyChallengesæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...');
                        if (typeof initDailyChallenges === 'function') {
                            initDailyChallenges();
                        }
                    }
                    
                    // âœ… é‡å†™updateChallengeProgresså‡½æ•°
                    const originalUpdateChallengeProgress = window.updateChallengeProgress;
                    
                    window.updateChallengeProgress = function(type, value = 1) {
                        console.log('ğŸ”„ [è‡ªåŠ¨ä¿®å¤] æ›´æ–°æŒ‘æˆ˜è¿›åº¦ - ç±»å‹:', type, 'å€¼:', value);
                        
                        let updated = false;
                        let completedChallenge = null;
                        
                        if (window.dailyChallenges) {
                            window.dailyChallenges.forEach(challenge => {
                                if (challenge.type === type && !challenge.completed) {
                                    console.log('ğŸ“Š æ‰¾åˆ°åŒ¹é…æŒ‘æˆ˜:', challenge.title, 'å½“å‰è¿›åº¦:', challenge.progress);
                                    
                                    if (type === 'click') {
                                        challenge.progress += value;
                                        console.log('ğŸ–±ï¸ ç‚¹å‡»æŒ‘æˆ˜è¿›åº¦æ›´æ–°:', challenge.progress, '/', challenge.target);
                                    } else if (type === 'time') {
                                        challenge.progress = Math.min(challenge.progress + value, challenge.target);
                                        console.log('â° æ—¶é—´æŒ‘æˆ˜è¿›åº¦æ›´æ–°:', challenge.progress, '/', challenge.target);
                                    } else if (type === 'accuracy') {
                                        challenge.progress += value;
                                        console.log('ğŸ¯ ç²¾å‡†æŒ‘æˆ˜è¿›åº¦æ›´æ–°:', challenge.progress, '/', challenge.target);
                                    }
                                    
                                    if (challenge.progress >= challenge.target) {
                                        challenge.completed = true;
                                        completedChallenge = challenge;
                                        console.log('ğŸ‰ æŒ‘æˆ˜å®Œæˆ:', challenge.title);
                                    }
                                    
                                    updated = true;
                                }
                            });
                            
                            if (updated) {
                                console.log('ğŸ’¾ ä¿å­˜æŒ‘æˆ˜è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨');
                                localStorage.setItem('dailyChallenges', JSON.stringify(window.dailyChallenges));
                                
                                // âœ… å…³é”®ï¼šç«‹å³æ›´æ–°ç¡¬ç¼–ç å…ƒç´ ï¼Œä¸ç®¡é¢æ¿æ˜¯å¦æ˜¾ç¤º
                                updateHardcodedChallengeElements();
                                
                                // æ›´æ–°ç»Ÿè®¡é¢æ¿
                                if (typeof updateDisplay === 'function') {
                                    updateDisplay();
                                }
                                
                                // å¦‚æœæœ‰æŒ‘æˆ˜å®Œæˆï¼Œæ˜¾ç¤ºé€šçŸ¥
                                if (completedChallenge) {
                                    setTimeout(() => {
                                        if (typeof playAchievementSound === 'function') {
                                            playAchievementSound();
                                        }
                                        if (typeof showNotification === 'function') {
                                            showNotification(\`ğŸ‰ æŒ‘æˆ˜å®Œæˆ: \${completedChallenge.title}! ç‚¹å‡»é¢†å–å¥–åŠ±\`, 'achievement');
                                        }
                                    }, 500);
                                }
                            }
                        }
                        
                        return updated;
                    };
                    
                    // âœ… ç¡®ä¿updateHardcodedChallengeElementså‡½æ•°å­˜åœ¨
                    if (typeof window.updateHardcodedChallengeElements !== 'function') {
                        window.updateHardcodedChallengeElements = function() {
                            console.log('ğŸ”„ æ›´æ–°ç¡¬ç¼–ç æŒ‘æˆ˜å…ƒç´ ...');
                            
                            if (window.dailyChallenges) {
                                window.dailyChallenges.forEach((challenge, index) => {
                                    const challengeNum = index + 1;
                                    const progressText = document.getElementById(\`progressText\${challengeNum}\`);
                                    const progressBar = document.getElementById(\`progress\${challengeNum}\`);
                                    const claimBtn = document.getElementById(\`claim\${challengeNum}\`);
                                    
                                    if (progressText) {
                                        const displayText = challenge.type === 'time' 
                                            ? \`\${Math.floor(challenge.progress / 60000)}/\${Math.floor(challenge.target / 60000)}åˆ†é’Ÿ\`
                                            : \`\${challenge.progress}/\${challenge.target}\`;
                                        progressText.textContent = displayText;
                                        console.log(\`ğŸ“ æŒ‘æˆ˜\${challengeNum}æ–‡æœ¬æ›´æ–°:\`, displayText);
                                    }
                                    
                                    if (progressBar) {
                                        const percentage = Math.min((challenge.progress / challenge.target) * 100, 100);
                                        progressBar.style.width = \`\${percentage}%\`;
                                        console.log(\`ğŸ“Š æŒ‘æˆ˜\${challengeNum}è¿›åº¦æ¡:\`, \`\${percentage}%\`);
                                    }
                                    
                                    if (claimBtn) {
                                        if (challenge.completed && !challenge.claimed) {
                                            claimBtn.disabled = false;
                                            claimBtn.classList.add('available');
                                            claimBtn.textContent = 'é¢†å–';
                                            console.log(\`ğŸ æŒ‘æˆ˜\${challengeNum}å¯é¢†å–å¥–åŠ±\`);
                                        } else if (challenge.claimed) {
                                            claimBtn.disabled = true;
                                            claimBtn.classList.add('claimed');
                                            claimBtn.textContent = 'å·²é¢†å–';
                                            console.log(\`âœ… æŒ‘æˆ˜\${challengeNum}å·²é¢†å–\`);
                                        } else {
                                            claimBtn.disabled = true;
                                            claimBtn.textContent = 'é¢†å–';
                                        }
                                    }
                                });
                            }
                            
                            console.log('âœ… ç¡¬ç¼–ç æŒ‘æˆ˜å…ƒç´ æ›´æ–°å®Œæˆ');
                        };
                    }
                    
                    // âœ… ç«‹å³æ›´æ–°å½“å‰æŒ‘æˆ˜çŠ¶æ€
                    if (window.dailyChallenges) {
                        console.log('ğŸ“‹ å½“å‰æŒ‘æˆ˜çŠ¶æ€:', window.dailyChallenges.map(c => ({
                            title: c.title,
                            progress: c.progress,
                            target: c.target,
                            completed: c.completed
                        })));
                        
                        updateHardcodedChallengeElements();
                    }
                    
                    console.log('ğŸ‰ è‡ªåŠ¨ä¿®å¤å®Œæˆï¼ç°åœ¨ç‚¹å‡»é‡‘å¸æŸ¥çœ‹å®æ—¶æ›´æ–°æ•ˆæœ');
                    console.log('ğŸ’¡ æç¤ºï¼šä¸éœ€è¦æ‰“å¼€æŒ‘æˆ˜é¢æ¿ï¼Œè¿›åº¦ä¼šç›´æ¥æ˜¾ç¤º');
                `;
                
                gameDoc.head.appendChild(script);
                fixApplied = true;
                updateStatus('âœ… è‡ªåŠ¨ä¿®å¤å·²åº”ç”¨ï¼ç°åœ¨å¯ä»¥æµ‹è¯•æŒ‘æˆ˜åŠŸèƒ½äº†ã€‚', 'success');
                
            } catch (error) {
                updateStatus('âŒ ä¿®å¤å¤±è´¥: ' + error.message, 'error');
                console.error('ä¿®å¤é”™è¯¯:', error);
            }
        }

        function testChallenge1() {
            if (!gameWindow || gameWindow.closed) {
                updateStatus('âŒ è¯·å…ˆæ‰“å¼€æ¸¸æˆé¡µé¢ï¼', 'error');
                return;
            }
            
            try {
                // åœ¨æ¸¸æˆçª—å£ä¸­æ¨¡æ‹Ÿç‚¹å‡»
                const script = gameWindow.document.createElement('script');
                script.textContent = `
                    if (typeof updateChallengeProgress === 'function') {
                        updateChallengeProgress('click', 5);
                        console.log('ğŸ§ª æµ‹è¯•ï¼šæŒ‘æˆ˜1è¿›åº¦+5');
                    } else {
                        console.log('âŒ updateChallengeProgresså‡½æ•°æœªæ‰¾åˆ°');
                    }
                `;
                gameWindow.document.head.appendChild(script);
                updateStatus('ğŸ§ª å·²å‘é€æŒ‘æˆ˜1æµ‹è¯•ï¼Œè¯·åœ¨æ¸¸æˆæ§åˆ¶å°æŸ¥çœ‹ç»“æœ', 'success');
            } catch (error) {
                updateStatus('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        function simulateCoinClick() {
            if (!gameWindow || gameWindow.closed) {
                updateStatus('âŒ è¯·å…ˆæ‰“å¼€æ¸¸æˆé¡µé¢ï¼', 'error');
                return;
            }
            
            try {
                const script = gameWindow.document.createElement('script');
                script.textContent = `
                    // æ¨¡æ‹Ÿç‚¹å‡»é‡‘å¸
                    if (window.coins && window.coins.length > 0) {
                        const firstCoin = window.coins[0];
                        console.log('ğŸ’° æ¨¡æ‹Ÿç‚¹å‡»é‡‘å¸ï¼Œä½ç½®:', firstCoin.x, firstCoin.y);
                        
                        // è§¦å‘é‡‘å¸ç‚¹å‡»äº‹ä»¶
                        if (typeof coinClick === 'function') {
                            coinClick(firstCoin);
                        } else {
                            // ç›´æ¥è°ƒç”¨æŒ‘æˆ˜æ›´æ–°
                            updateChallengeProgress('click', 1);
                            updateChallengeProgress('accuracy', 1);
                        }
                    } else {
                        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°é‡‘å¸');
                        // ç›´æ¥æµ‹è¯•æŒ‘æˆ˜æ›´æ–°
                        updateChallengeProgress('click', 1);
                        updateChallengeProgress('accuracy', 1);
                    }
                `;
                gameWindow.document.head.appendChild(script);
                updateStatus('ğŸ’° å·²æ¨¡æ‹Ÿé‡‘å¸ç‚¹å‡»ï¼Œè¯·åœ¨æ¸¸æˆæ§åˆ¶å°æŸ¥çœ‹ç»“æœ', 'success');
            } catch (error) {
                updateStatus('âŒ æ¨¡æ‹Ÿå¤±è´¥: ' + error.message, 'error');
            }
        }

        function simulateAccurateClick() {
            if (!gameWindow || gameWindow.closed) {
                updateStatus('âŒ è¯·å…ˆæ‰“å¼€æ¸¸æˆé¡µé¢ï¼', 'error');
                return;
            }
            
            try {
                const script = gameWindow.document.createElement('script');
                script.textContent = `
                    updateChallengeProgress('accuracy', 1);
                    console.log('ğŸ¯ æ¨¡æ‹Ÿç²¾å‡†ç‚¹å‡»+1');
                `;
                gameWindow.document.head.appendChild(script);
                updateStatus('ğŸ¯ å·²å‘é€ç²¾å‡†ç‚¹å‡»æµ‹è¯•', 'success');
            } catch (error) {
                updateStatus('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkChallengeStatus() {
            if (!gameWindow || gameWindow.closed) {
                updateStatus('âŒ è¯·å…ˆæ‰“å¼€æ¸¸æˆé¡µé¢ï¼', 'error');
                return;
            }
            
            try {
                const script = gameWindow.document.createElement('script');
                script.textContent = `
                    if (window.dailyChallenges) {
                        console.log('ğŸ“Š å½“å‰æŒ‘æˆ˜çŠ¶æ€:');
                        window.dailyChallenges.forEach((c, i) => {
                            console.log(\`æŒ‘æˆ˜\${i+1}: \${c.title} - \${c.progress}/\${c.target} (å®Œæˆ: \${c.completed})\`);
                        });
                    } else {
                        console.log('âŒ dailyChallengesæœªå®šä¹‰');
                    }
                `;
                gameWindow.document.head.appendChild(script);
                updateStatus('ğŸ“Š å·²å‘é€çŠ¶æ€æŸ¥è¯¢ï¼Œè¯·åœ¨æ¸¸æˆæ§åˆ¶å°æŸ¥çœ‹', 'success');
            } catch (error) {
                updateStatus('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.onload = function() {
            updateStatus('ğŸš€ è‡ªåŠ¨ä¿®å¤å·¥å…·å·²å‡†å¤‡å°±ç»ªï¼');
        };
    </script>
</body>
</html>